---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import TagPill from "./TagPill.astro";

interface Props {
    meeting: CollectionEntry<"meetings">;
    variant?: "default" | "compact";
}

const { meeting, variant = "default" } = Astro.props;
const { title, date, time, location, themeSlug } = meeting.data;

// Get the linked theme if available
const themes = await getCollection("themes");
const linkedTheme = themeSlug ? themes.find((t) => t.id === themeSlug) : null;

// Format the date nicely
const meetingDate = new Date(date);
const formattedDate = meetingDate.toLocaleDateString("en-US", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
});

// Check if meeting is in the past
const isPast = meetingDate < new Date();
const isUpcoming = !isPast;
---

{
    variant === "compact" ? (
        <div class:list={["card p-4", isPast && "opacity-75"]}>
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-lg text-mystic-500 dark:text-mystic-400">
                            <i class="fa-solid fa-sharp fa-calendar" />
                        </span>
                        <time
                            datetime={date}
                            class="text-sm font-medium text-mystic-600 dark:text-mystic-400"
                        >
                            {formattedDate}
                        </time>
                    </div>
                    {time && (
                        <p class="text-sm text-mystic-500 dark:text-mystic-500 ml-7">
                            {time}
                        </p>
                    )}
                    {linkedTheme && (
                        <a
                            href={`/themes/${linkedTheme.id}`}
                            class="inline-block mt-2 ml-7 text-sm font-medium text-bermuda-600 dark:text-bermuda-400 hover:text-bermuda-700 dark:hover:text-bermuda-300"
                        >
                            Theme: {linkedTheme.data.title}
                        </a>
                    )}
                </div>
                {isUpcoming && <TagPill variant="success">Upcoming</TagPill>}
            </div>
        </div>
    ) : (
        <article class:list={["card card-hover", isPast && "opacity-80"]}>
            <div class="p-6">
                {/* Header with date badge */}
                <div class="flex items-start justify-between gap-4 mb-4">
                    <div class="flex items-center gap-3">
                        {/* Calendar icon/badge */}
                        <div class="w-14 h-14 bg-linear-to-br from-mystic-500 to-mystic-600 rounded-xl flex flex-col items-center justify-center text-white shadow-lg shadow-mystic-500/20">
                            <span class="text-xs font-medium uppercase tracking-wide">
                                {meetingDate.toLocaleDateString("en-US", {
                                    month: "short",
                                })}
                            </span>
                            <span class="text-xl font-bold leading-none">
                                {meetingDate.getDate()}
                            </span>
                        </div>
                        <div>
                            <h3 class="text-lg font-display font-semibold text-mystic-900 dark:text-mystic-100">
                                {title}
                            </h3>
                            <time
                                datetime={date}
                                class="text-sm text-mystic-500 dark:text-mystic-400"
                            >
                                {formattedDate}
                            </time>
                        </div>
                    </div>
                    {isUpcoming ? (
                        <TagPill variant="success">Upcoming</TagPill>
                    ) : (
                        <TagPill variant="neutral">Past</TagPill>
                    )}
                </div>

                {/* Details */}
                <div class="space-y-3 text-sm">
                    {time && (
                        <div class="flex items-center gap-2 text-mystic-600 dark:text-mystic-400">
                            <span class="text-mystic-400 dark:text-mystic-500 w-4">
                                <i class="fa-solid fa-sharp fa-clock" />
                            </span>
                            <span>{time}</span>
                        </div>
                    )}

                    {location && (
                        <div class="flex items-start gap-2 text-mystic-600 dark:text-mystic-400">
                            <span class="text-mystic-400 dark:text-mystic-500 w-4 mt-0.5 shrink-0">
                                <i class="fa-solid fa-sharp fa-location-dot" />
                            </span>
                            <span>{location}</span>
                        </div>
                    )}

                    {linkedTheme && (
                        <div class="flex items-center gap-2">
                            <span class="text-mystic-400 dark:text-mystic-500 w-4">
                                <i class="fa-solid fa-sharp fa-book-open" />
                            </span>
                            <a
                                href={`/themes/${linkedTheme.id}`}
                                class="font-medium text-bermuda-600 dark:text-bermuda-400 hover:text-bermuda-700 dark:hover:text-bermuda-300 transition-colors"
                            >
                                {linkedTheme.data.title}
                            </a>
                        </div>
                    )}
                </div>

                {/* CTA for upcoming meetings */}
                {isUpcoming && (
                    <div class="mt-4 pt-4 border-t border-mystic-100 dark:border-mystic-800">
                        <a
                            href={`/meetings/${meeting.id}`}
                            class="inline-flex items-center gap-2 text-sm font-semibold text-mystic-600 dark:text-mystic-400 hover:text-mystic-800 dark:hover:text-mystic-200 transition-colors"
                        >
                            View details
                            <i class="fa-solid fa-sharp fa-chevron-right text-xs" />
                        </a>
                    </div>
                )}
            </div>
        </article>
    )
}
