---
import Layout from "../../layouts/Layout.astro";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
    const meetings = await getCollection("meetings");
    return meetings.map((meeting) => ({
        params: { id: meeting.id },
        props: { meeting },
    }));
}

const { meeting } = Astro.props;
const { title, date, time, location, themeSlug, agenda } = meeting.data;

// Get the linked theme if available
const themes = await getCollection("themes");
const linkedTheme = themeSlug ? themes.find((t) => t.id === themeSlug) : null;

// Render the MDX content
const { Content } = await render(meeting);

// Format the date nicely
const meetingDate = new Date(date);
const formattedDate = meetingDate.toLocaleDateString("en-US", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
});

// Check if meeting is in the past
const isPast = meetingDate < new Date();
---

<Layout
    title={title}
    description={`${title} - ${linkedTheme ? `Theme: ${linkedTheme.data.title}` : "Bermuda Triangle Society meeting"}`}
>
    <!-- Page Header -->
    <section
        class="bg-linear-to-b from-mystic-900 to-mystic-800 text-white py-16 md:py-20"
    >
        <div class="max-w-4xl mx-auto px-4">
            <a
                href="/meetings"
                class="inline-flex items-center gap-2 text-mystic-300 hover:text-white mb-6 transition-colors"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Meetings
            </a>

            <div class="flex flex-wrap items-center gap-3 mb-4">
                {
                    isPast ? (
                        <span class="px-3 py-1 bg-mystic-700 text-mystic-200 rounded-full text-sm font-medium">
                            Past Meeting
                        </span>
                    ) : (
                        <span class="px-3 py-1 bg-bermuda-500 text-white rounded-full text-sm font-medium">
                            Upcoming
                        </span>
                    )
                }
            </div>

            <h1 class="text-4xl md:text-5xl font-display font-bold mb-4">
                {title}
            </h1>

            <div class="flex flex-wrap items-center gap-6 text-mystic-200">
                <div class="flex items-center gap-2">
                    <svg
                        class="w-5 h-5 text-lantern-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        ></path>
                    </svg>
                    <time datetime={date}>{formattedDate}</time>
                </div>
                {
                    time && (
                        <div class="flex items-center gap-2">
                            <svg
                                class="w-5 h-5 text-lantern-400"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                            </svg>
                            <span>{time}</span>
                        </div>
                    )
                }
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section class="py-12 md:py-16">
        <div class="max-w-4xl mx-auto px-4">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Main Column -->
                <div class="lg:col-span-2">
                    <!-- MDX Content -->
                    <div class="prose prose-mystic mb-8">
                        <Content />
                    </div>

                    <!-- Agenda -->
                    {
                        agenda && agenda.length > 0 && (
                            <div class="card p-6 mb-8">
                                <h2 class="text-xl font-display font-semibold mb-4 flex items-center gap-2">
                                    <span class="text-lantern-500">
                                        <i class="fa-clipboard-list fa-solid fa-sharp" />
                                    </span>
                                    Meeting Agenda
                                </h2>
                                <ol class="space-y-3">
                                    {agenda.map((item, index) => (
                                        <li class="flex items-start gap-3">
                                            <span class="w-6 h-6 bg-mystic-100 dark:bg-mystic-700 dark:text-white text-mystic-600 rounded-full flex items-center justify-center shrink-0 text-sm font-semibold">
                                                {index + 1}
                                            </span>
                                            <span class="text-mystic-700 dark:text-mystic-300">
                                                {item}
                                            </span>
                                        </li>
                                    ))}
                                </ol>
                            </div>
                        )
                    }
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Location Card -->
                    {
                        location && (
                            <div class="card p-6 mb-6">
                                <h3 class="text-lg font-display font-semibold mb-3 flex items-center gap-2">
                                    <span class="text-bermuda-500">
                                        <i class="fa-location-dot fa-solid fa-sharp" />
                                    </span>
                                    Location
                                </h3>
                                <address class="not-italic text-mystic-600 dark:text-mystic-300 text-sm">
                                    {location}
                                </address>
                                <a
                                    href="https://bnl.bm"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="inline-flex items-center gap-1 mt-3 text-sm text-bermuda-600 hover:text-bermuda-700 dark:text-bermuda-300 hover:dark:text-bermuda-400"
                                >
                                    Visit library website
                                    <svg
                                        class="w-3 h-3"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                                        />
                                    </svg>
                                </a>
                            </div>
                        )
                    }

                    <!-- Linked Theme Card -->
                    {
                        linkedTheme && (
                            <div class="card p-6">
                                <h3 class="text-lg font-display font-semibold mb-3 flex items-center gap-2">
                                    <span class="text-lantern-500">
                                        <i class="fa-books fa-solid fa-sharp" />
                                    </span>
                                    Theme
                                </h3>
                                <a
                                    href={`/themes/${linkedTheme.id}`}
                                    class="block group"
                                >
                                    <h4 class="font-semibold group-hover:text-mystic-600 transition-colors mb-2">
                                        {linkedTheme.data.title}
                                    </h4>
                                    <p class="text-sm text-mystic-600 dark:text-mystic-300 line-clamp-3">
                                        {linkedTheme.data.summary}
                                    </p>
                                    <span class="inline-flex items-center gap-1 mt-3 text-sm font-medium text-bermuda-600 hover:text-bermuda-700 dark:text-bermuda-300 hover:dark:text-bermuda-400 group-hover:text-bermuda-700">
                                        View theme details
                                        <i class="fa-solid fa-sharp fa-chevron-right" />
                                    </span>
                                </a>

                                {linkedTheme.data.starterList &&
                                    linkedTheme.data.starterList.length > 0 && (
                                        <div class="mt-4 pt-4 border-t border-mystic-200">
                                            <p class="text-xs  mb-2">
                                                Quick picks:
                                            </p>
                                            <ul class="space-y-1">
                                                {linkedTheme.data.starterList
                                                    .slice(0, 3)
                                                    .map((book) => (
                                                        <li class="text-sm text-mystic-600 dark:text-mystic-300">
                                                            • {book.title}
                                                        </li>
                                                    ))}
                                            </ul>
                                        </div>
                                    )}
                            </div>
                        )
                    }

                    <!-- What to Bring -->
                    {
                        !isPast && (
                            <div class="card p-6 mt-6">
                                <h3 class="text-lg font-display font-semibold mb-3 flex items-center gap-2">
                                    <span>
                                        <i class="fa-solid fa-sharp fa-sparkles" />
                                    </span>
                                    What to Bring
                                </h3>
                                <ul class="text-sm text-mystic-700 dark:text-mystic-200 space-y-2">
                                    <li class="flex items-start gap-2">
                                        <span class="text-lantern-500">•</span>A
                                        book that fits the theme (optional!)
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-lantern-500">•</span>A
                                        2-3 minute pitch if sharing
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-lantern-500">•</span>
                                        Theme ideas for future meetings
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-lantern-500">•</span>
                                        Your enthusiasm (required!)
                                    </li>
                                </ul>
                            </div>
                        )
                    }
                </div>
            </div>
        </div>
    </section>

    <!-- Navigation -->
    <section class="py-8">
        <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
            <a
                href="/meetings"
                class="inline-flex items-center gap-2 text-mystic-600 hover:text-mystic-800 font-medium transition-colors"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
                All Meetings
            </a>
            {
                linkedTheme && (
                    <a
                        href={`/themes/${linkedTheme.id}`}
                        class="inline-flex items-center gap-2 text-mystic-600 hover:text-mystic-800 font-medium transition-colors"
                    >
                        View Theme
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5l7 7-7 7"
                            />
                        </svg>
                    </a>
                )
            }
        </div>
    </section>
</Layout>

<style>
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
