---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import SessionCard from '../components/SessionCard.astro';
import StarterList from '../components/StarterList.astro';
import Time from '../components/Time.svelte';
import { getCollection } from 'astro:content';

// Get sessions
const sessions = await getCollection('sessions');

// Find current session
const currentSession = sessions.find(s => s.data.status === 'current');

// Get upcoming sessions (sorted by date)
const upcomingSessions = sessions
  .filter(s => s.data.status === 'upcoming')
  .sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime());

const nextSession = currentSession || upcomingSessions[0];

// Get past sessions for the "explore more" section
const pastSessions = sessions
  .filter(s => s.data.status === 'past')
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 3);

// Format date helper
function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    month: 'long',
    day: 'numeric',
    timeZone: 'utc',
  });
}
---

<Layout>
  <!-- Hero Section -->
  <Hero>
    <Fragment slot="primary-cta">
      {currentSession ? (
        <a href={`/sessions/${currentSession.id}`} class="btn btn-primary">
          <span>See Next Session</span>
          <i class="fa-solid fa-sharp fa-arrow-right ml-2"></i>
        </a>
      ) : (
        <a href="/sessions" class="btn btn-primary">
          <span>Explore Sessions</span>
          <i class="fa-solid fa-sharp fa-arrow-right ml-2"></i>
        </a>
      )}
    </Fragment>

    <Fragment slot="meeting-teaser">
      {nextSession && (
        <div class="mt-8 inline-flex items-center gap-3 px-4 py-2 bg-mystic-800/50 rounded-full border border-mystic-600/30 backdrop-blur-sm">
          <span class="text-lantern-400 animate-pulse"><i class="fa-solid fa-sharp fa-sparkle"></i></span>
          <div class="text-sm text-mystic-200 flex items-center gap-2">
              Next session: <strong class="text-white">{formatDate(nextSession.data.date)}</strong>
              <a href={`/sessions/${nextSession.id}.ics`}><i class="fa-solid fa-sharp fa-calendar-arrow-down text-bermuda-500 text-lg"></i></a>
          </div>
        </div>
      )}
    </Fragment>
  </Hero>

  <!-- How It Works Section -->
  <section class="py-16 md:py-20 transition-colors duration-300 relative overflow-hidden">
    <!-- Nautical chart grid background -->
    <div class="absolute inset-0 opacity-[0.03] dark:opacity-[0.05] pointer-events-none" aria-hidden="true">
      <svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <pattern id="nautical-grid" width="100" height="100" patternUnits="userSpaceOnUse">
            <path d="M 100 0 L 0 0 0 100" fill="none" stroke="currentColor" stroke-width="0.5" class="text-mystic-900 dark:text-mystic-300"/>
            <circle cx="0" cy="0" r="2" fill="currentColor" class="text-mystic-600 dark:text-mystic-400"/>
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#nautical-grid)"/>
      </svg>
    </div>

    <!-- Subtle compass rose in corner -->
    <div class="absolute top-12 -right-12 w-48 h-48 opacity-[0.04] dark:opacity-[0.06] pointer-events-none" aria-hidden="true">
      <svg viewBox="0 0 100 100" class="w-full h-full text-mystic-700 dark:text-mystic-300">
        <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="0.5"/>
        <circle cx="50" cy="50" r="35" fill="none" stroke="currentColor" stroke-width="0.3"/>
        <path d="M50 5 L53 50 L50 95 L47 50 Z" fill="currentColor"/>
        <path d="M5 50 L50 47 L95 50 L50 53 Z" fill="currentColor"/>
        <path d="M15 15 L52 48 L85 85 L48 52 Z" fill="currentColor" opacity="0.5"/>
        <path d="M85 15 L52 48 L15 85 L48 52 Z" fill="currentColor" opacity="0.5"/>
      </svg>
    </div>

    <div class="relative max-w-6xl mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-display font-bold text-mystic-900 dark:text-mystic-100 mb-4">
          How It Works
        </h2>
        <p class="text-lg text-mystic-600 dark:text-mystic-400 max-w-2xl mx-auto">
          No assigned reading. No pressure. Just good conversations about books we love.
        </p>
      </div>

      <div class="grid md:grid-cols-3 gap-8">
        <!-- Step 1 -->
        <div class="relative text-center group">
          <div class="w-16 h-16 mx-auto mb-4 bg-linear-to-br from-mystic-500 to-mystic-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg shadow-mystic-500/20 group-hover:scale-110 transition-transform">
            <i class="fa-solid fa-sharp fa-bullseye"></i>
          </div>
          <h3 class="text-xl font-display font-semibold text-mystic-900 dark:text-mystic-100 mb-2">
            Vote on a Theme
          </h3>
          <p class="text-mystic-600 dark:text-mystic-400">
            Each month, members vote on a theme like "Lost at Sea" or "Portal Fantasy." Anyone can submit theme ideas!
          </p>
        </div>

        <!-- Step 2 -->
        <div class="relative text-center group">
          <!-- Mysterious eye decoration -->
          <div class="absolute -top-2 right-0 w-8 h-8 opacity-[0.07] dark:opacity-[0.1] pointer-events-none" aria-hidden="true">
            <svg viewBox="0 0 40 24" class="w-full h-full text-bermuda-700 dark:text-bermuda-400">
              <ellipse cx="20" cy="12" rx="18" ry="10" fill="none" stroke="currentColor" stroke-width="2"/>
              <circle cx="20" cy="12" r="5" fill="currentColor"/>
              <circle cx="20" cy="12" r="2" fill="none" stroke="currentColor" stroke-width="1" class="text-mystic-50 dark:text-mystic-900"/>
            </svg>
          </div>
          <div class="w-16 h-16 mx-auto mb-4 bg-linear-to-br from-bermuda-500 to-bermuda-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg shadow-bermuda-500/20 group-hover:scale-110 transition-transform">
            <i class="fa-solid fa-sharp fa-books"></i>
          </div>
          <h3 class="text-xl font-display font-semibold text-mystic-900 dark:text-mystic-100 mb-2">
            Read What You Want
          </h3>
          <p class="text-mystic-600 dark:text-mystic-400">
            Pick <em>any</em> book that fits the theme—or just come to listen. We share a starter list to help you choose.
          </p>
        </div>

        <!-- Step 3 -->
        <div class="relative text-center group">
          <!-- Arcane triangle decoration -->
          <div class="absolute -bottom-2 -right-2 w-10 h-10 opacity-[0.06] dark:opacity-[0.08] pointer-events-none" aria-hidden="true">
            <svg viewBox="0 0 40 40" class="w-full h-full text-lantern-600 dark:text-lantern-400">
              <polygon points="20,2 38,35 2,35" fill="none" stroke="currentColor" stroke-width="2"/>
              <circle cx="20" cy="23" r="4" fill="currentColor"/>
            </svg>
          </div>
          <div class="w-16 h-16 mx-auto mb-4 bg-linear-to-br from-lantern-500 to-lantern-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg shadow-lantern-500/20 group-hover:scale-110 transition-transform">
            <i class="fa-solid fa-sharp fa-comments"></i>
          </div>
          <h3 class="text-xl font-display font-semibold text-mystic-900 dark:text-mystic-100 mb-2">
            Share & Discover
          </h3>
          <p class="text-mystic-600 dark:text-mystic-400">
            Give a quick pitch at the meeting: what's it about, did it work for you, and who would love it?
          </p>
        </div>
      </div>

      <div class="text-center mt-10">
        <a href="/about" class="inline-flex items-center gap-2 text-mystic-600 dark:text-mystic-400 hover:text-mystic-800 dark:hover:text-mystic-200 font-medium transition-colors">
          Learn more about sessions
          <i class="fa-solid fa-sharp fa-arrow-right"></i>
        </a>
      </div>
    </div>
  </section>

  <!-- Current Session Section -->
  {currentSession && (
    <section class="py-16 md:py-20 transition-colors duration-300 relative">
      <!-- Dotted navigation lines decoration -->
      <div class="absolute top-20 left-0 w-32 h-32 opacity-[0.04] dark:opacity-[0.06] pointer-events-none" aria-hidden="true">
        <svg viewBox="0 0 100 100" class="w-full h-full text-mystic-700 dark:text-mystic-400">
          <path d="M0 50 Q25 25 50 50 T100 50" fill="none" stroke="currentColor" stroke-width="1.5" stroke-dasharray="4 4"/>
          <path d="M20 20 Q50 50 80 30" fill="none" stroke="currentColor" stroke-width="1" stroke-dasharray="2 3"/>
          <circle cx="50" cy="50" r="3" fill="currentColor"/>
          <circle cx="80" cy="30" r="2" fill="currentColor"/>
        </svg>
      </div>

      <!-- Subtle tentacle in corner -->
      <div class="absolute bottom-10 right-0 w-40 h-40 opacity-[0.03] dark:opacity-[0.05] pointer-events-none" aria-hidden="true">
        <svg viewBox="0 0 100 100" class="w-full h-full text-bermuda-700 dark:text-bermuda-400">
          <path d="M100 100 Q80 80 70 60 Q65 40 50 30 Q40 25 30 30" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
          <path d="M100 80 Q85 70 75 50 Q70 35 55 25" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
          <path d="M100 60 Q90 55 82 40" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="30" cy="30" r="4" fill="currentColor"/>
          <circle cx="55" cy="25" r="3" fill="currentColor"/>
        </svg>
      </div>

      <div class="max-w-6xl mx-auto px-4 relative">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
          <div>
            <span class="inline-flex items-center gap-2 text-sm font-semibold text-mystic-500 dark:text-mystic-400 uppercase tracking-wide mb-2">
              <span class="text-lantern-500"><i class="fa-solid fa-sharp fa-sparkles"></i></span>
              Next Session
            </span>
            <h2 class="text-3xl md:text-4xl font-display font-bold text-mystic-900 dark:text-mystic-100">
              {currentSession.data.themeTitle}
            </h2>
          </div>
          <a href={`/sessions/${currentSession.id}`} class="btn btn-outline self-start md:self-auto">
            View Session Details
          </a>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
          <!-- Session description -->
          <div class="card p-6 md:p-8">
            <p class="text-lg text-mystic-700 dark:text-mystic-300 leading-relaxed mb-6">
              {currentSession.data.themeSummary}
            </p>

            {currentSession.data.tags && (
              <div class="flex flex-wrap gap-2">
                {currentSession.data.tags.map((tag: string) => (
                  <span class="px-3 py-1 bg-mystic-100 dark:bg-mystic-800 text-mystic-600 dark:text-mystic-400 text-sm rounded-full">
                    {tag}
                  </span>
                ))}
              </div>
            )}

            <div class="mt-6 pt-6 border-t border-mystic-100 dark:border-mystic-800 flex items-center gap-3 text-mystic-600 dark:text-mystic-400">
              <span class="text-2xl text-lantern-500"><i class="fa-solid fa-sharp fa-calendar-day"></i></span>
              <div>
                <p class="text-sm text-mystic-500 dark:text-mystic-500">Date</p>
                <p class="font-semibold text-mystic-800 dark:text-mystic-200">{formatDate(currentSession.data.date)} <a href={`/sessions/${nextSession.id}.ics`} class="relative top-0.5"><i class="fa-solid fa-sharp fa-calendar-arrow-down text-bermuda-500 text-2xl"></i></a></p>
              </div>

            </div>
            <div class="mt-2 pt-2 flex items-center gap-3 text-mystic-600 dark:text-mystic-400">
              <span class="text-2xl text-lantern-500"><i class="fa-solid fa-sharp fa-clock"></i></span>
              <div>
                <p class="text-sm text-mystic-500 dark:text-mystic-500">Time</p>
                <p class="font-semibold text-mystic-800 dark:text-mystic-200"><Time start={currentSession.data.start} duration={currentSession.data.duration}  /></p>
              </div>
            </div>
          </div>

          <!-- Starter list preview -->
          {currentSession.data.starterList && (
            <div class="bg-linear-to-br from-mystic-50 to-bermuda-50 dark:from-mystic-900 dark:to-mystic-950 rounded-2xl p-6 md:p-8">
              <StarterList books={currentSession.data.starterList.slice(0, 3)} compact />
              {currentSession.data.starterList.length > 3 && (
                <p class="mt-4 text-sm text-mystic-500 dark:text-mystic-400 text-center">
                    +{currentSession.data.starterList.length - 3} more recommendation{currentSession.data.starterList.length > 4 ? 's' : ''} on the session page
                </p>
              )}
            </div>
          )}
        </div>
      </div>
    </section>
  )}

  <!-- Upcoming Session Section (if no current session) -->
  {!currentSession && upcomingSessions.length > 0 && (
    <section class="py-16 md:py-20 bg-linear-to-br from-mystic-100 to-bermuda-50 dark:from-mystic-900 dark:to-mystic-900 transition-colors duration-300 relative overflow-hidden">
      <!-- Eldritch star pattern -->
      <div class="absolute top-10 right-10 w-24 h-24 opacity-[0.05] dark:opacity-[0.08] pointer-events-none" aria-hidden="true">
        <svg viewBox="0 0 100 100" class="w-full h-full text-mystic-700 dark:text-mystic-400">
          <polygon points="50,0 61,35 98,35 68,57 79,91 50,70 21,91 32,57 2,35 39,35" fill="none" stroke="currentColor" stroke-width="2"/>
          <circle cx="50" cy="50" r="8" fill="currentColor"/>
        </svg>
      </div>
      <div class="max-w-4xl mx-auto px-4 relative">
        <div class="text-center mb-8">
          <span class="inline-flex items-center gap-2 text-sm font-semibold text-bermuda-600 dark:text-bermuda-400 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-sharp fa-calendar"></i>
            Coming Up
          </span>
          <h2 class="text-3xl md:text-4xl font-display font-bold text-mystic-900 dark:text-mystic-100">
            Next Session
          </h2>
        </div>

        <SessionCard session={upcomingSessions[0]} />

        <div class="text-center mt-8">
          <a href="/sessions" class="inline-flex items-center gap-2 text-mystic-600 dark:text-mystic-400 hover:text-mystic-800 dark:hover:text-mystic-200 font-medium transition-colors">
            View all sessions
            <i class="fa-solid fa-sharp fa-arrow-right"></i>
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- Past Sessions Section -->
  {pastSessions.length > 0 && (
    <section class="py-16 md:py-20 transition-colors duration-300 relative overflow-hidden">
      <!-- Nautical map coordinate marks -->
      <div class="absolute inset-0 pointer-events-none" aria-hidden="true">
        <div class="absolute top-8 left-8 text-[10px] font-mono text-mystic-400/20 dark:text-mystic-600/20">32°18'N</div>
        <div class="absolute top-8 right-8 text-[10px] font-mono text-mystic-400/20 dark:text-mystic-600/20">64°47'W</div>
        <div class="absolute bottom-8 left-8 text-[10px] font-mono text-mystic-400/20 dark:text-mystic-600/20">25°00'N</div>
        <div class="absolute bottom-8 right-8 text-[10px] font-mono text-mystic-400/20 dark:text-mystic-600/20">80°00'W</div>
      </div>

      <!-- Subtle Bermuda Triangle outline -->
      <div class="absolute inset-0 flex items-center justify-center opacity-[0.02] dark:opacity-[0.04] pointer-events-none" aria-hidden="true">
        <svg viewBox="0 0 400 350" class="w-full max-w-4xl h-auto text-mystic-700 dark:text-mystic-400">
          <polygon points="200,20 380,320 20,320" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="8 4"/>
          <circle cx="200" cy="20" r="6" fill="currentColor"/>
          <circle cx="380" cy="320" r="6" fill="currentColor"/>
          <circle cx="20" cy="320" r="6" fill="currentColor"/>
        </svg>
      </div>

      <div class="max-w-6xl mx-auto px-4 relative">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-display font-bold text-mystic-900 dark:text-mystic-100 mb-4">
            Explore Past Sessions
          </h2>
          <p class="text-lg text-mystic-600 dark:text-mystic-400">
            Catch up on what we've discussed—and maybe find your next read.
          </p>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
          {pastSessions.map((session) => (
            <SessionCard
              session={session}
              variant="compact"
            />
          ))}
        </div>

        <div class="text-center mt-10">
          <a href="/sessions" class="btn btn-outline">
            Browse All Sessions
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- CTA Section -->
  <section class="py-16 md:py-24 bg-linear-to-br from-mystic-900 via-mystic-800 to-mystic-900 text-white relative overflow-hidden">
    <!-- Background decoration -->
    <div class="absolute inset-0 bg-stars opacity-30" aria-hidden="true"></div>
    <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-mystic-500/10 rounded-full blur-3xl" aria-hidden="true"></div>
    <div class="absolute bottom-1/4 right-1/4 w-64 h-64 bg-bermuda-500/10 rounded-full blur-3xl" aria-hidden="true"></div>

    <!-- Cthulhu tentacles creeping from edges -->
    <div class="absolute -bottom-4 -left-4 w-48 h-48 opacity-10 pointer-events-none" aria-hidden="true">
      <svg viewBox="0 0 100 100" class="w-full h-full text-bermuda-400">
        <path d="M0 100 Q20 80 25 60 Q30 40 20 25 Q15 15 25 5" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
        <path d="M15 100 Q30 85 40 70 Q50 55 45 40 Q42 30 50 20" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        <path d="M35 100 Q45 90 55 80 Q65 70 60 55" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <circle cx="25" cy="5" r="3" fill="currentColor"/>
        <circle cx="50" cy="20" r="2.5" fill="currentColor"/>
        <circle cx="60" cy="55" r="2" fill="currentColor"/>
      </svg>
    </div>

    <div class="absolute -top-4 -right-4 w-48 h-48 opacity-10 pointer-events-none transform rotate-180" aria-hidden="true">
      <svg viewBox="0 0 100 100" class="w-full h-full text-mystic-400">
        <path d="M0 100 Q20 80 25 60 Q30 40 20 25 Q15 15 25 5" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
        <path d="M15 100 Q30 85 40 70 Q50 55 45 40 Q42 30 50 20" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        <path d="M35 100 Q45 90 55 80 Q65 70 60 55" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <circle cx="25" cy="5" r="3" fill="currentColor"/>
        <circle cx="50" cy="20" r="2.5" fill="currentColor"/>
      </svg>
    </div>

    <!-- Mysterious arcane circle -->
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-125 h-125 opacity-[0.04] pointer-events-none" aria-hidden="true">
      <svg viewBox="0 0 200 200" class="w-full h-full text-lantern-400">
        <circle cx="100" cy="100" r="95" fill="none" stroke="currentColor" stroke-width="0.5"/>
        <circle cx="100" cy="100" r="80" fill="none" stroke="currentColor" stroke-width="0.3"/>
        <circle cx="100" cy="100" r="60" fill="none" stroke="currentColor" stroke-width="0.5"/>
        <!-- Arcane symbols -->
        <polygon points="100,20 115,70 170,70 125,100 140,150 100,120 60,150 75,100 30,70 85,70" fill="none" stroke="currentColor" stroke-width="0.5"/>
        <!-- Inner triangle -->
        <polygon points="100,40 145,130 55,130" fill="none" stroke="currentColor" stroke-width="0.5"/>
      </svg>
    </div>

    <div class="relative max-w-3xl mx-auto px-4 text-center">
      <span class="text-4xl text-lantern-400 mb-4 block"><i class="fa-solid fa-sharp fa-lightbulb"></i></span>
      <h2 class="text-3xl md:text-4xl font-display font-bold text-white mb-4">
        Got a Theme Idea?
      </h2>
      <p class="text-lg text-mystic-200 mb-8 max-w-xl mx-auto">
        "Time Loops & Reset Stories"? "Cozy Apocalypse"? "Unreliable Narrators"?
        We're always looking for fresh theme ideas from readers like you.
      </p>
      <a href="/submit" class="btn btn-secondary">
        <span>Submit a Theme</span>
        <i class="fa-solid fa-sharp fa-arrow-right ml-2"></i>
      </a>
    </div>
  </section>
</Layout>
